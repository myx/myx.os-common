#!/bin/sh

##### !!! This script is universal for FreeBSD, Darwin, Ubuntu. !!! #####

Async(){
	case "$1" in
			"")
				echo "async: prefix text argument is required!" >&2 ; exit 1
				;;
	        -1)
				local PREFTEXT="`basename $2`"
	            ;;
	        -2)
				local PREFTEXT="`basename $3`"
	            ;;
	        -3)
				local PREFTEXT="`basename $4`"
	            ;;
	        --)
				local PREFTEXT="${!#}"
	            ;;
	        *)
				local PREFTEXT="$1"
	esac
	shift

	local PREFTEXT="` tr '^' '-' <<<"$PREFTEXT" | tr -d '\n' `"

    echo "$PREFTEXT: starting..."
    (	(	( echo "" | "$@" 2>&1 ) \
	    	&& echo "finished." \
    		|| echo "ERROR: exited with error status." \
    	) | sed -e "s^\^^$PREFTEXT: ^" \
    ) & # parallel
}

case "$0" in
	*/myx.common/bin/lib/async) 
		if [ -z "$1" ] ; then
			echo "Syntax: myx.common lib/async [-1|-2|-3|<prefix-text>] command [... arguments]" >&2
			echo "    when -1, -2 or -3 is used in place of 'prefix text' argument" >$2
			echo "    the corresponding following argument of the command is used." >$2
			exit 1
		fi
		set -e
		Async "$@"
	;;
esac
