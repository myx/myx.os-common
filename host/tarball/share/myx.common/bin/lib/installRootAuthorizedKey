#!/bin/sh

##### !!! This script is universal for FreeBSD, Darwin, Ubuntu. !!! #####
#####                          (it depends on OS-dependent include) #####

set -e

if [ "`type -t UserRequireRoot`" != "function" ] ; then
. "/usr/local/share/myx.common/bin/user/requireRoot"
fi
if [ "`type -t ReplaceLine`" != "function" ] ; then
. "/usr/local/share/myx.common/bin/lib/replaceLine"
fi
if [ "`type -t GetRootHomeDirectory`" != "function" ] ; then
. "/usr/local/share/myx.common/bin/lib/getRootHomeDirectory"
fi

InstallRootAuthorizedKey(){
	UserRequireRoot "InstallRootAuthorizedKey"

	local KEY="$1"

	test ! -z "$KEY" || ( echo "InstallRootAuthorizedKey: key is required!" ; exit 2 )

	local HOME="`GetRootHomeDirectory`"
	local KEYS="$HOME/.ssh/authorized_keys"
	
	mkdir -p "$HOME/.ssh"
	touch "$KEYS"
	
	ReplaceLine "$KEYS" "$KEY" "$KEY"
	
	chown root:root "$KEYS"
	chmod 600 "$KEYS"
}

case "$0" in
	*/myx.common/bin/lib/installRootAuthorizedKey) 
		InstallRootAuthorizedKey "$@"
	;;
esac
